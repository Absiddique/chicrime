suppressMessages(library(shiny))
suppressMessages(library(ggplot2))
suppressMessages(library(ggmap))
suppressMessages(library(RJSONIO))
suppressMessages(library(png))
suppressMessages(library(grid))
suppressMessages(library(RCurl))
suppressMessages(library(plyr))
suppressMessages(library(markdown))
suppressMessages(library(rCharts))
suppressMessages(library(parallel))
suppressMessages(library(xts))
suppressMessages(library(stringr))

## Define server logic required to summarize and view the selected dataset
shinyServer(function(input, output) {
  
  
  ## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ## Reactive Functions
  ## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  
  load(file = "./data/weather.rda", envir = .GlobalEnv)
  load(file = "./data/crimestest.rda", envir = .GlobalEnv)
  
  #Need to figure this out
  #crimebydate <- reactive({subset(df, PosixDate > as.POSIXct(strptime(input$startdate, format="%Y-%m-%d")) & PosixDate < as.POSIXct(strptime(input$enddate, format="%Y-%m-%d"))) })
  #crimetypedatabase <- reactive({subset(crimebydate, Primary.Type == input$crimetype)})

  ## Get Geocode  DELETE
  map.geocode <- reactive({
    suppressMessages(data.frame(geocode = geocode(input$poi)))
  })
  
  ## Define Period DELETE
  map.period <- reactive({
    format(seq(input$start, length=input$months, by="months"), "%Y-%m")
  })

      
    ## Output
    df
    #crimetypedatabase
   
  ## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ## Output 1 - Data Table
  ## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
  output$datatable <- renderDataTable({
    #Subsets by date
    crimebydate <- subset(df, PosixDate > as.POSIXct(strptime(input$startdate, format="%Y-%m-%d")) & PosixDate < as.POSIXct(strptime(input$enddate, format="%Y-%m-%d")))
    ##Creates smaller database based on crime type
    crimetypedatabase <- subset(crimebydate, Primary.Type == input$crimetype)
   # crimetypedatabase$PosixDate <- as.POSIXct(strptime(crimetypedatabase$Date, format="%m/%d/%Y %H:%M"))
    crimetypedatabase
    
  }, options = list(aLengthMenu = c(10, 25, 50, 100, 1000), iDisplayLength = 10))
  
  ## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ## Output 2 - Map
  ## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
  output$map <- renderPlot({
    ##Center Map on Chicago
    map.center <- geocode("Chicago,IL", messaging = FALSE)  #output = c('lon','lat')
    colnames(map.center) <- c("lon","lat")
    
    ##Creates smaller database based on crime type
    crimebydate <- subset(df, PosixDate > as.POSIXct(strptime(input$startdate, format="%Y-%m-%d")) & PosixDate < as.POSIXct(strptime(input$enddate, format="%Y-%m-%d")))
    crimetypedatabase <- subset(crimebydate, Primary.Type == input$crimetype)
    
    ##Plots values
    ##Need to update to allow for other types of maps
    ##Maybe map with another source - get google map
    ##SHmap <- qmap(c(lon=map.center$lon, lat=map.center$lat), source="google", zoom=12)
 
    map.center = geocode(input$center, messaging = FALSE)
    temp.color <- "color"
    if (input$bw) {temp.color <- "bw"}
    temp.scale <- 1
    if (input$res) {temp.scale <- 2}
    
    map.base <- get_googlemap(
      as.matrix(map.center),
      maptype = input$type, ## Map type as defined above (roadmap, terrain, satellite, hybrid)
     # markers = map.center,
      zoom = input$zoom,            ## 14 is just about right for a 1-mile radius
      color = temp.color,   ## "color" or "bw" (black & white)
      scale = temp.scale,  ## Set it to 2 for high resolution output
      messaging = FALSE,
      # other settings that are not used at the moment
      # language = "en-EN" Ref: https://spreadsheets.google.com/spreadsheet/pub?key=0Ah0xU81penP1cDlwZHdzYWkyaERNc0xrWHNvTTA1S1E&gid=1
      # style              Ref: https://developers.google.com/maps/documentation/staticmaps/#StyledMapElements
    )
    
    ## Convert the base map into a ggplot object
    ## All added Cartesian coordinates to enable more geom options later on
    map.base <- ggmap(map.base, extend = "panel", messaging = FALSE) + coord_cartesian() + coord_fixed(ratio = 1.5)
 
    ## add crime points
 p <- map.base + geom_point(aes(x=Longitude, y=Latitude), colour="red", size = 4, na.rm=TRUE, data=crimetypedatabase)
  
 print(p)
  }, width = 1280, height = 1280)
  
  ###### TRENDS ###########
    output$trends1 <- renderPlot({
    
    crimebydate <- subset(df, PosixDate > as.POSIXct(strptime(input$startdate, format="%Y-%m-%d")) & PosixDate < as.POSIXct(strptime(input$enddate, format="%Y-%m-%d")))
    crimetypedatabase <- subset(crimebydate, Primary.Type == input$crimetype)

  #Convert to XTS for analysis Columns should be Primary Type and PosixData
    df.xts <- xts(x = crimetypedatabase[, c(6,23)], order.by = crimetypedatabase[, "PosixDate"])
    #dyearly <- apply.yearly(df.xts, function(d) {print(d)}) # Troubleshooting
  #sum by crime type - NEED to allow different periods
    crimebytime <- apply.monthly(df.xts, function(d) {sum(str_count(d, input$crimetype ))})
    crimebytime<-data.frame(index(crimebytime),coredata(crimebytime[,1]))
    colnames(crimebytime)<-c("dates","crime")
  
 ##ADD WEATHER
 weatherdata <- subset(weatherdata, PosixDate > as.POSIXct(strptime(input$startdate, format="%Y-%m-%d")) & PosixDate < as.POSIXct(strptime(input$enddate, format="%Y-%m-%d")))
 weatherxts <- xts(weatherdata$TempFahr,weatherdata$PosixDate)
 weatherxts<-data.frame(index(weatherxts),coredata(weatherxts[,1]))
 colnames(weatherxts)<-c("dates","temperature")

# Plotting
 data<-ggplot(crimebytime,aes(dates,crime)) + xlab(NULL) + ylab("crime") + scale_y_log10() 
 data2 <- data +geom_line(aes(color="First line"))+ ggtitle("Crime Trends")
 data3 <- data2 +geom_line(data=weatherxts,aes(dates, temperature, color="Second line"))
 
#New approach to get two Y lines:

library(ggplot2)
library(gtable)
library(grid)

grid.newpage()

# two plots
# from http://rpubs.com/kohske/dual_axis_in_ggplot2

p1 <-ggplot(crimebytime,aes(dates,crime)) + geom_line(aes(color="red")) + theme_bw()
p2 <-ggplot(weatherxts,aes(dates,temperature)) + geom_line(aes(color="blue")) + theme_bw() %+replace% 
  theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t, 
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)

# draw it
grid.draw(g)








#print(data3)
  }, width = 800, height = 800)
  
  })
    
